{% extends 'base.html' %}
{% load static %}

{% block title %}Eric's Consulting - Professional Legal & Business Services{% endblock %}

{% block css %}
<style>
    /* Hero Section Specific Styles */
    .modern-hero {
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #0ea5e9 100%);
        padding: 120px 0 100px;
        position: relative;
        overflow: hidden;
    }

    .modern-hero::before {
        content: '';
        position: absolute;
        width: 150%;
        height: 150%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
        background-size: 50px 50px;
        animation: moveGrid 20s linear infinite;
    }

    @keyframes moveGrid {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
    }

    .hero-content {
        position: relative;
        z-index: 2;
    }

    @keyframes shimmer {
        0%, 100% { transform: translate(0, 0); opacity: 0; }
        50% { transform: translate(-25%, -25%); opacity: 1; }
    }

    @media (max-width: 991px) {
        .modern-hero {
            min-height: auto !important;
            padding: 80px 0 60px;
        }
        .hero-image img {
            height: 400px !important;
        }
        .hero-image > div {
            transform: perspective(1000px) rotateY(-3deg) rotateX(1deg) !important;
        }
    }

    @media (max-width: 767px) {
        .modern-hero {
            min-height: auto !important;
        }
        .hero-image img {
            height: 350px !important;
        }
        .hero-image > div {
            transform: none !important;
            border-radius: 20px !important;
        }
    }

    /* Feature Cards */
    .feature-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        transition: all 0.3s ease;
        height: 100%;
        border: 2px solid transparent;
    }

    .feature-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(37, 99, 235, 0.2);
        border-color: #2563eb;
    }

    .feature-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
    }

    /* Stats Section */
    .stats-card {
        text-align: center;
        padding: 30px;
    }

    .stat-value {
        font-size: 3.5rem;
        font-weight: 800;
        color: white;
        line-height: 1;
        margin-bottom: 10px;
    }

    .stat-label {
        font-size: 1.125rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
    }

    /* About Section */
    .about-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        border-radius: 24px;
        padding: 50px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    }

    /* Team Section */
    .team-carousel .owl-nav button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        background: white !important;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        color: #2563eb !important;
        font-size: 20px;
        transition: all 0.3s ease;
    }

    .team-carousel .owl-nav button:hover {
        background: #2563eb !important;
        color: white !important;
        transform: translateY(-50%) scale(1.1);
    }

    .team-carousel .owl-nav button.owl-prev {
        left: -25px;
    }

    .team-carousel .owl-nav button.owl-next {
        right: -25px;
    }

    .team-carousel .owl-dots {
        margin-top: 30px;
        text-align: center;
    }

    .team-carousel .owl-dot {
        width: 12px;
        height: 12px;
        background: #cbd5e1;
        border-radius: 50%;
        display: inline-block;
        margin: 0 5px;
        transition: all 0.3s ease;
    }

    .team-carousel .owl-dot.active {
        background: #2563eb;
        width: 30px;
        border-radius: 6px;
    }

    /* Comment/Testimonial Section */
    .comment-form {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-top: 40px;
    }

    /* Chat Widget */
    .chat-widget {
        position: fixed;
        bottom: 30px;
        left: 30px;
        z-index: 998;
    }

    .chat-icon {
        width: 65px;
        height: 65px;
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);
        transition: all 0.3s ease;
        position: relative;
    }

    .chat-icon::before {
        content: '';
        position: absolute;
        inset: -3px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        opacity: 0;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0; transform: scale(1); }
        50% { opacity: 0.3; transform: scale(1.15); }
    }

    .chat-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 32px rgba(37, 99, 235, 0.5);
    }

    .chat-window {
        display: none;
        position: fixed;
        bottom: 110px;
        left: 30px;
        width: 380px;
        height: 550px;
        background: white;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        flex-direction: column;
        overflow: hidden;
        z-index: 999;
        border: 1px solid rgba(37, 99, 235, 0.1);
    }

    .chat-window.show {
        display: flex;
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-header {
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        padding: 20px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .chat-header h5 {
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chat-header h5::before {
        content: '';
        width: 10px;
        height: 10px;
        background: #48bb78;
        border-radius: 50%;
        box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.3);
        animation: statusPulse 2s infinite;
    }

    @keyframes statusPulse {
        0%, 100% { box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.3); }
        50% { box-shadow: 0 0 0 6px rgba(72, 187, 120, 0.1); }
    }

    .chat-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        line-height: 1;
    }

    .chat-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .chat-message {
        padding: 12px 16px;
        border-radius: 16px;
        max-width: 80%;
        word-wrap: break-word;
        font-size: 0.95rem;
        line-height: 1.5;
        animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-message.user {
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }

    .chat-message.bot {
        background: white;
        color: #1e293b;
        align-self: flex-start;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .chat-input-area {
        padding: 18px 20px;
        background: white;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .chat-input-area input {
        flex: 1;
        border: 2px solid #e2e8f0;
        border-radius: 25px;
        padding: 12px 20px;
        font-size: 0.95rem;
        outline: none;
        transition: all 0.3s ease;
    }

    .chat-input-area input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .chat-send-btn {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .chat-send-btn:hover {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
    }

    .chat-send-btn:active {
        transform: scale(0.95);
    }

    /* Mobile Responsive Chat Widget */
    @media (max-width: 767px) {
        .chat-widget {
            bottom: 20px;
            left: 20px;
        }

        .chat-icon {
            width: 55px;
            height: 55px;
            font-size: 24px;
        }

        .chat-window {
            position: fixed;
            bottom: 90px;
            left: 15px;
            right: 15px;
            width: calc(100% - 30px);
            height: 400px;
            max-height: 60vh;
            border-radius: 20px;
        }

        .chat-header {
            padding: 16px 18px;
        }

        .chat-header h5 {
            font-size: 1rem;
        }

        .chat-messages {
            padding: 15px;
            gap: 10px;
        }

        .chat-message {
            padding: 10px 14px;
            font-size: 0.9rem;
            max-width: 85%;
        }

        .chat-input-area {
            padding: 14px 16px;
        }

        .chat-input-area input {
            padding: 10px 16px;
            font-size: 0.9rem;
        }

        .chat-send-btn {
            width: 42px;
            height: 42px;
            font-size: 1rem;
        }
    }

    @media (max-width: 575px) {
        .chat-icon {
            width: 50px;
            height: 50px;
            font-size: 22px;
        }

        .chat-window {
            bottom: 80px;
            left: 10px;
            right: 10px;
            width: calc(100% - 20px);
            height: 380px;
            max-height: 55vh;
        }

        .chat-header {
            padding: 14px 16px;
        }

        .chat-header h5 {
            font-size: 0.95rem;
        }

        .chat-close {
            width: 32px;
            height: 32px;
            font-size: 1.3rem;
        }

        .chat-input-area {
            padding: 12px 14px;
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
        }
    }
</style>
{% endblock %}

{% block content %}

<!-- Modern Hero Section -->
<section class="modern-hero" style="min-height: 800px; display: flex; align-items: center;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-5 mb-5 mb-lg-0">
                <div class="hero-content wow fadeInLeft" data-wow-delay="0.1s">
                    <h1 class="hero-title text-white mb-4">
                        The Best Legal Jurisdiction Begins Here
                    </h1>
                    <p class="hero-subtitle text-white mb-4">
                        Expert legal consultation and services tailored to individuals and businesses navigating the complexities of U.S. law. Professional guidance you can trust.
                    </p>
                    <div class="hero-buttons">
                        <a href="{% url 'service' %}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-briefcase me-2"></i>Our Services
                        </a>
                        <a href="{% url 'contact' %}" class="btn btn-outline btn-lg" style="border-color: white; color: white;">
                            <i class="fas fa-phone me-2"></i>Contact Us
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="hero-image wow fadeInRight" data-wow-delay="0.3s" style="position: relative;">
                    <div style="position: relative; overflow: hidden; border-radius: 30px; box-shadow: 0 40px 80px rgba(0, 0, 0, 0.5); transform: perspective(1200px) rotateY(-8deg) rotateX(2deg);">
                        <img src="{% static 'img/carousel-1.jpg' %}" alt="Legal Consulting" class="img-fluid" style="width: 100%; height: 600px; object-fit: cover; display: block; border-radius: 30px;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(37, 99, 235, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%); border-radius: 30px;"></div>
                        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: shimmer 3s infinite;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Stats Section -->
<section class="stats-section py-5">
    <div class="container py-4">
        <div class="row g-4">
            <div class="col-lg-3 col-md-6 wow fadeIn" data-wow-delay="0.1s">
                <div class="stats-card">
                    <div class="stat-value" data-toggle="counter-up">120</div>
                    <div class="stat-label">Happy Clients</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 wow fadeIn" data-wow-delay="0.2s">
                <div class="stats-card">
                    <div class="stat-value" data-toggle="counter-up">144</div>
                    <div class="stat-label">Projects Succeed</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 wow fadeIn" data-wow-delay="0.3s">
                <div class="stats-card">
                    <div class="stat-value" data-toggle="counter-up">159</div>
                    <div class="stat-label">Active Projects</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 wow fadeIn" data-wow-delay="0.4s">
                <div class="stats-card">
                    <div class="stat-value" data-toggle="counter-up">15</div>
                    <div class="stat-label">Pending Projects</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features/Why Choose Us Section -->
<section class="section-padding bg-light">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto text-center wow fadeInUp" data-wow-delay="0.1s">
                <h2 class="section-title">Why Choose Us</h2>
                <p class="section-subtitle">
                    We stand out with our unwavering commitment to clients, personalized service, and comprehensive solutions tailored to your needs.
                </p>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-lg-3 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                <div class="feature-card">
                    <img src="{% static 'img/icon/icon-06-primary.png' %}" alt="Easy Process" class="feature-icon">
                    <h5 class="mb-3">Easy Process</h5>
                    <p class="text-muted">Streamlined procedures designed for your convenience and peace of mind.</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 wow fadeInUp" data-wow-delay="0.2s">
                <div class="feature-card">
                    <img src="{% static 'img/icon/icon-03-primary.png' %}" alt="Fast Delivery" class="feature-icon">
                    <h5 class="mb-3">Fast Delivery</h5>
                    <p class="text-muted">Quick turnaround times without compromising on quality or accuracy.</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 wow fadeInUp" data-wow-delay="0.3s">
                <div class="feature-card">
                    <img src="{% static 'img/icon/icon-04-primary.png' %}" alt="Expert Guidance" class="feature-icon">
                    <h5 class="mb-3">Expert Guidance</h5>
                    <p class="text-muted">Professional advice from experienced legal consultants you can trust.</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 wow fadeInUp" data-wow-delay="0.4s">
                <div class="feature-card">
                    <img src="{% static 'img/icon/icon-07-primary.png' %}" alt="Cost Effective" class="feature-icon">
                    <h5 class="mb-3">Cost Effective</h5>
                    <p class="text-muted">Affordable solutions that deliver exceptional value for your investment.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- About Us Section -->
<section class="section-padding">
    <div class="container">
        <div class="row">
            <div class="col-lg-10 mx-auto wow fadeInUp" data-wow-delay="0.1s">
                <div class="about-card">
                    <h2 class="section-title text-center mb-4">About Eric's Consulting</h2>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <p style="font-size: 1.0625rem; line-height: 1.8; color: #475569;">
                                <strong>Eric's Consulting LLC</strong> was established on March 3, 2023, in Loveland, Ohio, USA. Our mission is to provide comprehensive civil services to the Uzbek community and brotherly peoples from the Central Asian region living in America.
                            </p>
                            <p style="font-size: 1.0625rem; line-height: 1.8; color: #475569;">
                                We specialize in business entity formation, streamlining trucking company operations, and providing placement assistance, license acquisition, loan support, tax advice, housing services, visa consultations, childcare, and school placement services.
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p style="font-size: 1.0625rem; line-height: 1.8; color: #475569;">
                                Our main goal is to offer affordable and high-quality services to Uzbek citizens living in the USA!
                            </p>
                            <p style="font-size: 1.0625rem; line-height: 1.8; color: #475569;">
                                Founded and led by <strong>lawyer Erkinbai Abdullaev</strong>, who brings 14 years of experience from various ministries and agencies of the republic, plus 2 years working in the branch of a German logistics company in Poland.
                            </p>
                            <div class="mt-4">
                                <a href="{% url 'service' %}" class="btn btn-primary">
                                    <i class="fas fa-arrow-right me-2"></i>Explore Our Services
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Team Section -->
<section class="section-padding bg-light">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto text-center wow fadeInUp" data-wow-delay="0.1s">
                <h2 class="section-title">Meet Our Expert Team</h2>
                <p class="section-subtitle">
                    Our team of highly experienced professionals is dedicated to providing the best service possible with professionalism and expertise.
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="team-carousel owl-carousel wow fadeInUp" data-wow-delay="0.2s">
                    {% for member in team_members %}
                        <div class="team-card">
                            <div class="team-img-wrapper">
                                {% if member.user.profile_picture %}
                                    <img src="{{ member.user.profile_picture.url }}" alt="{{ member.user.first_name }} {{ member.user.last_name }}">
                                {% else %}
                                    <img src="{% static 'img/icon/logo-white.png' %}" alt="Default Profile">
                                {% endif %}
                                <div class="team-overlay">
                                    <div class="team-social">
                                        {% if member.twitter %}
                                            <a href="{{ member.twitter }}" target="_blank"><i class="fab fa-twitter"></i></a>
                                        {% endif %}
                                        {% if member.instagram %}
                                            <a href="{{ member.instagram }}" target="_blank"><i class="fab fa-instagram"></i></a>
                                        {% endif %}
                                        {% if member.facebook %}
                                            <a href="{{ member.facebook }}" target="_blank"><i class="fab fa-facebook-f"></i></a>
                                        {% endif %}
                                        {% if member.linkedin %}
                                            <a href="{{ member.linkedin }}" target="_blank"><i class="fab fa-linkedin-in"></i></a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="team-info">
                                <h5 class="team-name">{{ member.user.first_name }} {{ member.user.last_name }}</h5>
                                <p class="team-role mb-0">{{ member.role }}</p>
                            </div>
                            <div class="team-description">
                                {% if member.description %}
                                    <p>{{ member.description }}</p>
                                {% else %}
                                    <p>Bringing a fresh perspective and innovative approach, {{ member.user.first_name }} is instrumental in developing creative strategies and solutions.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Testimonials Section -->
<section class="section-padding">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto text-center wow fadeInUp" data-wow-delay="0.1s">
                <h2 class="section-title">What People Are Saying</h2>
                <p class="section-subtitle">
                    Hear from our satisfied clients about their experiences with our services.
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="owl-carousel testimonial-carousel wow fadeInUp" data-wow-delay="0.2s">
                    {% for comment in comments %}
                        <div class="testimonial-card text-center">
                            <img class="testimonial-avatar"
                                 src="{% if comment.user.profile_picture %}{{ comment.user.profile_picture.url }}{% else %}{% static 'img/icon/logo-white.png' %}{% endif %}"
                                 alt="{{ comment.user.first_name }}"
                                 style="width: 80px !important; height: 80px !important; border-radius: 50% !important; object-fit: cover !important; object-position: center !important;">
                            <p class="testimonial-content">"{{ comment.content }}"</p>
                            <h5 class="testimonial-author">{{ comment.user.first_name }} {{ comment.user.last_name }}</h5>
                            <p class="testimonial-date">{{ comment.created_at|date:"F d, Y" }}</p>
                        </div>
                    {% empty %}
                        <div class="testimonial-card text-center">
                            <p class="text-muted">No testimonials yet. Be the first to share your experience!</p>
                        </div>
                    {% endfor %}
                </div>

                <!-- Comment Form -->
                {% if request.user.is_authenticated %}
                    <div class="comment-form wow fadeInUp" data-wow-delay="0.3s">
                        <h4 class="mb-4">Share Your Experience</h4>
                        <form method="POST" action="">
                            {% csrf_token %}
                            <div class="form-group mb-4">
                                <label for="id_content" class="form-label">Your Comment</label>
                                <textarea id="id_content" name="content" class="form-control" rows="4" placeholder="Tell us about your experience with our services..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Submit Comment
                            </button>
                        </form>
                    </div>
                {% else %}
                    <div class="text-center mt-5 wow fadeInUp" data-wow-delay="0.3s">
                        <p class="text-muted">Want to share your experience?
                            <a href="{% url 'login' %}" class="text-primary fw-bold">Login</a> or
                            <a href="{% url 'register' %}" class="text-primary fw-bold">Register</a> to leave a comment.
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Chat Widget -->
<div class="chat-widget">
    <div class="chat-icon" id="chat-icon">
        <i class="fas fa-comments"></i>
    </div>
    <div class="chat-window" id="chat-window">
        <div class="chat-header">
            <h5 class="mb-0">Live Chat</h5>
            <button class="chat-close" id="chat-close-button">&times;</button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow-1">
            <button class="chat-send-btn" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<script>
    $(document).ready(function() {
        // Team Carousel
        $('.team-carousel').owlCarousel({
            loop: true,
            margin: 30,
            nav: true,
            navText: ['<i class="fas fa-chevron-left"></i>', '<i class="fas fa-chevron-right"></i>'],
            dots: true,
            autoplay: true,
            autoplayTimeout: 4000,
            autoplayHoverPause: true,
            smartSpeed: 800,
            responsive: {
                0: { items: 1 },
                768: { items: 2 },
                992: { items: 3 }
            }
        });

        // Testimonial Carousel
        $('.testimonial-carousel').owlCarousel({
            loop: true,
            margin: 30,
            nav: false,
            dots: true,
            autoplay: true,
            autoplayTimeout: 5000,
            autoplayHoverPause: true,
            smartSpeed: 800,
            responsive: {
                0: { items: 1 },
                768: { items: 1 },
                992: { items: 1 }
            }
        });

        // Counter Up with Waypoints
        if ($('[data-toggle="counter-up"]').length) {
            $('[data-toggle="counter-up"]').each(function() {
                var $this = $(this);
                var waypoint = new Waypoint({
                    element: this,
                    handler: function() {
                        $this.counterUp({
                            delay: 10,
                            time: 2000
                        });
                        this.destroy();
                    },
                    offset: '80%'
                });
            });
        }

        // Chat Widget Functions
        function fetchChatHistory() {
            $.ajax({
                url: '{% url "chat_with_bot" %}',
                method: 'GET',
                success: function(response) {
                    $('#chat-messages').empty();
                    if (response.chat_history && response.chat_history.length > 0) {
                        response.chat_history.forEach(function(message) {
                            var messageClass = message.sender === 'user' ? 'user' : 'bot';
                            $('#chat-messages').append(
                                '<div class="chat-message ' + messageClass + '">' +
                                escapeHtml(message.text) +
                                '</div>'
                            );
                        });
                    }
                    scrollToBottom();
                },
                error: function(error) {
                    console.error('Error fetching chat history:', error);
                }
            });
        }

        function scrollToBottom() {
            var chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function sendMessage(userMessage) {
            $('#chat-messages').append(
                '<div class="chat-message user">' + escapeHtml(userMessage) + '</div>'
            );
            $('#chat-input').val('');
            scrollToBottom();

            $.ajax({
                url: '{% url "chat_with_bot" %}',
                method: 'POST',
                data: {
                    'message': userMessage,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.messages) {
                        response.messages.forEach(function(msg) {
                            $('#chat-messages').append(
                                '<div class="chat-message bot">' + escapeHtml(msg.text) + '</div>'
                            );
                        });
                    }
                    scrollToBottom();
                },
                error: function(error) {
                    if (error.status === 401) {
                        $('#chat-messages').append(
                            '<div class="chat-message bot">Please log in or register to use the chatbot.</div>'
                        );
                    } else {
                        console.error('Error sending message:', error);
                    }
                    scrollToBottom();
                }
            });
        }

        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Chat Widget Event Handlers
        $('#chat-icon').on('click', function() {
            $('#chat-window').toggleClass('show');
            if ($('#chat-window').hasClass('show')) {
                fetchChatHistory();
            }
        });

        $('#chat-close-button').on('click', function() {
            $('#chat-window').removeClass('show');
        });

        $('#send-button').on('click', function() {
            var userMessage = $('#chat-input').val().trim();
            if (userMessage) {
                sendMessage(userMessage);
            }
        });

        $('#chat-input').on('keypress', function(e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                var userMessage = $(this).val().trim();
                if (userMessage) {
                    sendMessage(userMessage);
                }
            }
        });
    });
</script>
{% endblock %}
