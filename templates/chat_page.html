{% extends 'base.html' %}
{% load static %}

{% block css %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Page</title>
<link href="{% static 'lib/animate/animate.min.css' %}" rel="stylesheet">
<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'css/style.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
    body {
        background-color: #e5ddd5;
        font-family: 'Helvetica', 'Arial', sans-serif;
        margin: 0;
    }

    .chat-container {
        display: flex;
        height: 80vh;
        overflow: hidden;
    }

    /* User list */
    .user-list {
        width: 30%;
        background-color: #f8f9fa;
        padding: 15px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        height: 100%;
    }

    .user-list h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: #007bff;
    }

    .user {
        padding: 10px;
        background-color: white;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 10px;
        transition: background-color 0.2s ease;
        position: relative; /* Needed for unread indicator */
        display: flex;
        align-items: center; /* Align items vertically center */
        justify-content: space-between; /* Space between text and indicator */
    }

    .user:hover {
        background-color: #007bff;
        color: #fff;
    }

    /* Chat window */
    .chat-window1 {
        width: 70%;
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #ffffff;
        padding: 15px;
        overflow: hidden;
    }

    .chat-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }

    /* Chat box */
    .chat-box {
        flex-grow: 1;
        padding: 10px;
        background-color: #f1f1f1;
        border-radius: 8px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Message styling */
    .message {
        padding: 10px;
        border-radius: 5px;
        position: relative;
        display: inline-block;
        max-width: 70%;
        word-wrap: break-word;
    }

    .message.customer {
        background-color: #d1e7dd;
        align-self: flex-start;
        text-align: left;
        border-bottom-left-radius: 0;
    }

    .message.assistant {
        background-color: #d9edf7;
        align-self: flex-end;
        text-align: right;
        border-bottom-right-radius: 0;
        margin-left: auto;
    }

    .message .firstname {
        font-weight: bold;
        color: #007bff;
    }

    .message .timestamp {
        font-size: 12px;
        color: gray;
        margin-top: 5px;
        align-self: flex-end;
    }

    /* Input section */
    .input-group {
        margin-top: auto;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        align-items: center;
    }

    #message-input {
        resize: none;
        border: none;
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
        width: 100%;
        min-height: 40px;
    }

    #send-message-button {
        background-color: #007bff;
        color: #fff;
        border-radius: 5px;
        margin-left: 10px;
        padding: 10px 15px;
    }

    /* Button hover effect */
    #send-message-button:hover {
        background-color: #0056b3;
    }

    /* Unread indicator style */
    .unread-indicator {
        width: 10px;
        height: 10px;
        background-color: red;
        border-radius: 50%;
        margin-left: 10px; /* Space between name and indicator */
    }
</style>
{% endblock %}

{% block content %}
    
       {% if messages %}
        <div class="messages">
        {% for message in messages %}
            <div class="alert alert-danger" role="alert" class="error-message">
                {{ message }}
            </div>
        {% endfor %}
        </div>
        {% endif %}
    
    <div class="container mt-5">
        <div class="card">
            <div class="card-body">
                <div class="chat-container">
                    <!-- User list -->
                    <div class="user-list">
                        <h3>Users</h3>
                        {% for user in users %}
                            <div class="user" data-chat-id="{{ user.chat_id }}" data-firstname="{{ user.first_name }}">
                                <div class="firstname">{{ user.first_name }}</div>
                                {% if not user.is_read %}
                                    <div class="unread-indicator"></div> <!-- Red circular indicator -->
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Chat window -->
                    <div class="chat-window1">
                        <div class="chat-header">Messages</div>
                        <div class="chat-box">
                            <!-- Messages will be appended here dynamically -->
                        </div>

                        <!-- Message input -->
                        <div class="input-group">
                            <textarea id="message-input" class="form-control" rows="1" placeholder="Write your message here..."></textarea>
                            <button id="send-message-button" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="{% static 'lib/wow/wow.min.js' %}"></script>
    <script src="{% static 'lib/easing/easing.min.js' %}"></script>
    <script src="{% static 'lib/waypoints/waypoints.min.js' %}"></script>
    <script src="{% static 'lib/counterup/counterup.min.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
    $(document).ready(function () {
        let selectedChatId = null;
        let selectedFirstName = null;
        let messagePollingInterval = null;

        // Function to fetch users and update the user list
        function fetchUsers() {
            $.ajax({
                url: "{% url 'fetch_users' %}",  // Replace with your actual URL for fetching users
                type: "GET",
                success: function (response) {
                    $('.user-list').empty();
                    response.users.forEach(function (user) {
                        const userClass = user.is_read ? "user" : "user"; // Class based on read status
                        $('.user-list').append(`
                            <div class="${userClass}" data-chat-id="${user.chat_id}" data-firstname="${user.first_name}">
                                <div class="firstname">${user.first_name}</div>
                                ${user.is_read ? '' : '<div class="unread-indicator"></div>'}
                            </div>
                        `);
                    });
                    bindUserClick();
                },
                error: function (xhr) {
                    alert("Error fetching users: " + xhr.responseText);
                }
            });
        }

        // Function to bind click event for each user
        function bindUserClick() {
            $('.user').off('click');
            $('.user').click(function () {
                $('.user').removeClass('active');
                $(this).addClass('active');

                selectedChatId = $(this).data('chat-id');
                selectedFirstName = $(this).data('firstname');

                // Fetch messages for the selected user
                fetchMessages();

                // Start polling for new messages
                startPolling();
            });
        }

        // Function to fetch messages for the selected user
        function fetchMessages() {
            if (selectedChatId === null) return;

            $.ajax({
                url: "{% url 'fetch_messages' %}",
                type: "GET",
                data: {
                    chat_id: selectedChatId,
                    first_name: selectedFirstName
                },
                success: function (response) {
                    $('.chat-box').empty();
                    response.messages.forEach(function (message) {
                        const messageClass = message.is_assistant ? 'assistant' : 'customer';
                        const displayName = message.is_assistant ? 'Assistant' : message.first_name;

                        $('.chat-box').append(`
                            <div class="message ${messageClass}">
                                <div class="firstname">${displayName}</div>
                                <div class="text">${message.message_text}</div>
                                <div class="timestamp">${message.created_at}</div>
                            </div>
                        `);
                    });

                    $('.chat-box').scrollTop($('.chat-box')[0].scrollHeight);
                },
                error: function (xhr) {
                    alert("Error fetching messages: " + xhr.responseText);
                }
            });

            // Mark messages as read
            markMessagesAsRead();
        }

        // Function to mark messages as read
        function markMessagesAsRead() {
            if (selectedChatId === null || selectedFirstName === null) return;

            $.ajax({
                url: "{% url 'mark_messages_as_read' %}",  // Define this URL in your Django app
                type: "POST",
                data: {
                    chat_id: selectedChatId,
                    first_name: selectedFirstName  // Add first_name here
                },
                success: function (response) {
                    fetchUsers(); // Refresh user list to update unread indicators
                },
                error: function (xhr) {
                    alert("Error marking messages as read: " + xhr.responseText);
                }
            });
        }

        // Send message
        $('#send-message-button').click(function () {
            const messageText = $('#message-input').val().trim();
            if (!messageText || selectedChatId === null) return;

            $.ajax({
                url: "{% url 'send_message_to_bot' %}",
                type: "POST",
                data: {
                    chat_id: selectedChatId,
                    first_name: selectedFirstName,
                    message: messageText,
                },
                success: function (response) {
                    $('#message-input').val(''); // Clear input after sending
                    fetchMessages(); // Fetch messages again
                    updateUnreadIndicator(selectedChatId); // Update unread indicator
                },
                error: function (xhr) {
                    alert("Error sending message: " + xhr.responseText);
                }
            });
        });

        // Function to update the unread indicator for the selected user
        function updateUnreadIndicator(chatId) {
            const userElement = $('.user[data-chat-id="' + chatId + '"]');
            if (userElement.length) {
                userElement.find('.unread-indicator').remove(); // Remove any existing indicator
                userElement.append('<div class="unread-indicator"></div>'); // Add new indicator
            }
        }

        // Poll for new messages and unread status
        function startPolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval); // Clear any existing polling interval
            }
            messagePollingInterval = setInterval(function () {
                fetchMessages(); // Fetch new messages every 5 seconds
                fetchUsers(); // Fetch users to update unread indicators
            }, 5000);
        }

        // Initial fetch of users
        fetchUsers();
    });
    setTimeout(function() {
            document.querySelectorAll('.error-message').forEach(function(element) {
                element.style.display = 'none';
            });
        }, 3000);
    </script>
{% endblock %}
