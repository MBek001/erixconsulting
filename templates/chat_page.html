{% extends 'base.html' %}
{% load static %}


{% block css %}
	 <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Page</title>
    <!-- Local Libraries Stylesheet -->
    <link href="{% static 'lib/animate/animate.min.css' %}" rel="stylesheet">

    <!-- Local Customized Bootstrap Stylesheet -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">

    <!-- Local Template Stylesheet -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
    body {
        background-color: #e5ddd5;
        font-family: 'Helvetica', 'Arial', sans-serif;
        margin: 0; /* Remove default body margin */
    }

    .chat-container {
        display: flex;
        height: 80vh; /* Set height for the chat container */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        overflow: hidden;
    }

    /* User list */
    .user-list {
        width: 30%; /* Set width for the user list */
        background-color: #f8f9fa;
        padding: 15px;
        border-right: 1px solid #ddd;
        overflow-y: auto; /* Allow user list to scroll */
        height: 100%; /* Full height to match chat window */
    }

    .user-list h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: #007bff;
    }

    .user {
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        background-color: #fff;
        margin-bottom: 10px;
        transition: background-color 0.2s ease;
    }

    .user:hover {
        background-color: #007bff;
        color: #fff;
    }

    /* Chat window */
    .chat-window1 {
        width: 70%; /* Set width for the chat window */
        display: flex;
        flex-direction: column;
        height: 100%; /* Full height to match user list */
        background-color: #ffffff;
        padding: 15px;
        overflow: hidden; /* Prevent overflow */
    }

    .chat-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        border-bottom: 1px solid #ddd; /* Add a bottom border for separation */
        padding-bottom: 10px; /* Space below the header */
    }

    /* Chat box */
    .chat-box {
        flex-grow: 1;
        padding: 10px;
        background-color: #f1f1f1;
        border-radius: 8px;
        overflow-y: auto; /* Allow chat box to scroll */
        display: flex;
        flex-direction: column;
        gap: 10px; /* Added gap between messages */
    }

    /* Message styling */
    .message {
        padding: 10px;
        border-radius: 5px;
        position: relative;
        display: inline-block;
        max-width: 70%;
        word-wrap: break-word; /* Allow messages to break */
    }

    .message.customer {
        background-color: #d1e7dd; /* Customer message background */
        align-self: flex-start;
        text-align: left;
        border-bottom-left-radius: 0;
    }

    .message.assistant {
        background-color: #d9edf7; /* Assistant message background */
        align-self: flex-end;
        text-align: right;
        border-bottom-right-radius: 0;
        margin-left: auto;
    }

    .message .firstname {
        font-weight: bold;
        color: #007bff;
    }

    .message .timestamp {
        font-size: 12px;
        color: gray;
        margin-top: 5px;
        align-self: flex-end;
    }

    /* Input section */
    .input-group {
        margin-top: auto;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        align-items: center;
    }

    #message-input {
        resize: none;
        border: none;
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
        width: 100%;
        min-height: 40px; /* Ensure a minimum height */
    }

    #send-message-button {
        background-color: #007bff;
        color: #fff;
        border-radius: 5px;
        margin-left: 10px;
        padding: 10px 15px;
    }

    /* Button hover effect */
    #send-message-button:hover {
        background-color: #0056b3; /* Darker blue on hover */
    }

</style>


{% endblock %}

{% block content %}

    <div class="container">
    <div class="chat-container">
        <!-- User list -->
        <div class="user-list">
            <h3>Users</h3>
            {% for user in users %}
                <div class="user" data-chat-id="{{ user.chat_id }}" data-firstname="{{ user.first_name }}">
                    <div class="firstname">{{ user.first_name }}</div>
                </div>
            {% endfor %}
        </div>

        <!-- Chat window -->
        <div class="chat-window1">
            <div class="chat-header">Messages</div>
            <div class="chat-box">
                <!-- Messages will be appended here dynamically -->
            </div>

            <!-- Message input -->
            <div class="input-group">
                <textarea id="message-input" class="form-control" rows="1" placeholder="Write your message here..."></textarea>
                <button id="send-message-button" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
     <!-- Local JavaScript Libraries -->
    <script src="{% static 'lib/wow/wow.min.js' %}"></script>
    <script src="{% static 'lib/easing/easing.min.js' %}"></script>
    <script src="{% static 'lib/waypoints/waypoints.min.js' %}"></script>
    <script src="{% static 'lib/counterup/counterup.min.js' %}"></script>

    <!-- Template Javascript -->
    <script src="{% static 'js/main.js' %}"></script>
<script>
    $(document).ready(function () {
    let selectedChatId = null;
    let selectedFirstName = null;

    // Function to fetch users and update the user list
    function fetchUsers() {
        $.ajax({
            url: "{% url 'fetch_users' %}",  // Replace with your actual URL for fetching users
            type: "GET",
            success: function (response) {
                // Clear the user list to avoid duplicates
                $('.user-list').empty();

                // Append each user to the list
                response.users.forEach(function (user) {
                    $('.user-list').append(`
                        <div class="user" data-chat-id="${user.chat_id}" data-firstname="${user.first_name}">
                            <div class="firstname">${user.first_name}</div>
                        </div>
                    `);
                });

                // Rebind click event for newly added users
                bindUserClick();
            },
            error: function (xhr) {
                alert("Foydalanuvchilarni olishda xatolik yuz berdi: " + xhr.responseText);
            }
        });
    }

    // Function to bind click event for each user
    function bindUserClick() {
        $('.user').off('click');  // Unbind previous click events to prevent stacking
        $('.user').click(function () {
            // Select the chat and highlight the selected user
            $('.user').removeClass('active');
            $(this).addClass('active');

            selectedChatId = $(this).data('chat-id');
            selectedFirstName = $(this).data('firstname');

            // Fetch the messages for the selected user
            fetchMessages();

            // Start polling for new messages
            startPolling();
        });
    }

    // Function to fetch messages for the selected user
    function fetchMessages() {
        if (selectedChatId === null) return; // Don't fetch if no chat is selected

        $.ajax({
            url: "{% url 'fetch_messages' %}",
            type: "GET",
            data: {
                chat_id: selectedChatId,
                first_name: selectedFirstName
            },
            success: function (response) {
                $('.chat-box').empty(); // Clear the chat box

                response.messages.forEach(function (message) {
                    const messageClass = message.is_assistant ? 'assistant' : 'customer';
                    const displayName = message.is_assistant ? 'Assistant' : message.first_name;

                    $('.chat-box').append(`
                        <div class="message ${messageClass}">
                            <div class="firstname">${displayName}</div>
                            <div class="text">${message.message_text}</div>
                            <div class="timestamp">${message.created_at}</div>
                        </div>
                    `);
                });

                // Scroll chat box to the bottom after fetching messages
                $('.chat-box').scrollTop($('.chat-box')[0].scrollHeight);
            },
            error: function (xhr) {
                alert("Xabarlarni olishda xatolik yuz berdi: " + xhr.responseText);
            }
        });
    }

    // Function to start polling for new messages
    function startPolling() {
        // Clear any existing interval
        if (window.pollingInterval) {
            clearInterval(window.pollingInterval);
        }

        // Fetch messages every 5 seconds (5000 ms)
        window.pollingInterval = setInterval(fetchMessages, 1500);
    }

    // Send message function
    function sendMessage() {
        const messageText = $('#message-input').val();
        if (messageText.trim() === '' || selectedChatId === null) {
            return;  // Don't send empty messages
        }

        $.ajax({
            url: "{% url 'send_message_to_bot' %}",
            type: "POST",
            data: {
                chat_id: selectedChatId,
                message: messageText,
                first_name: selectedFirstName,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function () {
                $('#message-input').val(''); // Clear input
                fetchMessages(); // Refresh messages immediately after sending
            },
            error: function (xhr) {
                alert("Xabar yuborishda xatolik yuz berdi: " + xhr.responseText);
            }
        });
    }

    // Handle sending the message on button click
    $('#send-message-button').click(function () {
        sendMessage();
    });

    // Handle Enter key for sending the message
    $('#message-input').keydown(function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault(); // Prevent new line
            sendMessage(); // Send message on Enter
        }
    });

    // Initial fetch of users and bind user click events
    fetchUsers();

    // Optional polling to update the user list every 10 seconds
    setInterval(fetchUsers, 10000);  // Adjust this interval as needed
});



</script>

{% endblock %}

